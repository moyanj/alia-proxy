# 本地存储

`aiprox` 的所有多媒体持久化功能都依赖于其强大的本地存储系统。这个系统被设计为既简单又高效，确保了所有生成的媒体资源都能被安全地存储和访问。

## 存储结构

- **根目录**: 所有媒体文件都存储在由 `config.toml` 中 `media_dir` 字段指定的目录下。默认情况下，这个目录是项目根目录下的 `data/media/`。

- **文件命名**: 为了避免文件名冲突和保证唯一性，所有保存的媒体文件都使用 **UUID (Universally Unique Identifier)** 进行重命名。
    - 例如，一个上传的 `photo.png` 文件可能会被保存为 `f8e2c1b0-c6a6-4b6f-8a0a-1b9e8e3f4b0f.png`。
    - 这种策略确保了即使同时处理成千上万个文件，也不会发生覆盖或冲突。

- **异步写入**: 所有的文件写入操作都是通过 `aiofiles` 库以**异步**方式执行的。这意味着文件 I/O 操作不会阻塞 FastAPI 的主事件循环，保证了即使在处理大文件时，`aiprox` 依然能保持高并发和低延迟。

## 媒体访问 API

所有存储在 `media_dir` 目录下的文件都可以通过一个统一的 API 端点进行访问：

```
GET /api/media/{filename}
```

- **`{filename}`**: 文件的 UUID 名称（包括扩展名）。

**示例**:
如果一个图片被保存为 `a1b2c3d4-....png`，那么可以通过访问 `http://localhost:8000/api/media/a1b2c3d4-....png` 来获取这张图片。

### 安全性

为了防止目录遍历攻击，`/api/media/` 端点在处理请求时，会强制过滤掉任何路径相关的字符（如 `../`），只使用文件名本身来构建文件路径。这确保了客户端只能访问到 `media_dir` 目录下的文件，无法访问服务器上的其他任何文件。

## 日志中的媒体处理

`aiprox` 的一个重要设计决策是**避免在数据库中存储大型二进制数据或 Base64 字符串**。

- **问题**: 将图片或音频的 Base64 编码直接存入数据库会导致数据库迅速膨胀，查询性能急剧下降，并增加备份和迁移的复杂性。

- **`aiprox` 的解决方案**:
    1.  **拦截与转存**: 在请求处理的早期阶段，所有 Base64 数据都被拦截并转存为本地文件。
    2.  **占位符记录**: 在写入数据库的 `RequestContent` 表时，原始的 Base64 字符串被一个轻量级的文本占位符替换，例如 `[IMAGE: a1b2c3d4-....png]`。
    3.  **外键关联**: 同时，在 `MediaResource` 表中创建一个新条目，记录文件名 `a1b2c3d4-....png`，并通过外键与主日志记录 `RequestLog` 相关联。

这种**引用式存储**（storing by reference）的设计，既保留了请求的完整上下文，又维持了数据库的轻量和高效。在 Web 仪表盘查看日志详情时，前端会根据 `MediaResource` 表中的记录，动态地构建指向 `/api/media/` 的 URL 来展示图片或播放音频。
